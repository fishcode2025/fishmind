# 数据库与服务层重构执行计划

## 概述

本计划旨在重构现有的服务架构和数据存储方式，将分散的存储逻辑统一到SQLite数据库中，并重新设计服务层以提高代码质量和可维护性。由于应用仍处于开发阶段，我们将简化计划为四个主要阶段，每个阶段都有明确的目标、任务和验证方法。

## 阶段一：基础设施搭建（第1-2周）

### 目标
建立统一的数据库服务和目录结构，为后续重构奠定基础。

### 任务

#### 1.1 创建目录结构
- 创建`src/services/database`目录
- 创建`src/repositories`目录
- 创建`src/models`目录（统一数据模型）

```code
# 关于repositories和models目录的用途

## repositories目录的用途

`repositories`目录是实现**存储库模式**（Repository Pattern）的地方，它主要负责：

1. **数据访问抽象**：提供统一的数据访问接口，隐藏底层数据存储的细节
2. **CRUD操作封装**：封装对数据的增删改查操作
3. **业务逻辑与数据访问分离**：使业务逻辑不直接依赖于数据访问方式

在我们的重构计划中，`repositories`目录将包含：

- **TopicRepository**：管理聊天话题的存储和检索
- **MessageRepository**：管理聊天消息的存储和检索
- **AiModelProviderRepository**：管理模型提供商的存储和检索
- **AiModelRepository**：管理AI模型的存储和检索
- **ConfigRepository**：管理应用配置的存储和检索

每个存储库都会使用`IDatabaseService`接口与数据库交互，这样即使将来更换数据库实现，也不需要修改业务逻辑。

## models目录的用途

`models`目录用于存放**数据模型定义**，它主要负责：

1. **统一数据结构**：定义应用中使用的所有数据结构
2. **类型安全**：利用TypeScript的类型系统确保数据结构的一致性
3. **代码复用**：避免在不同模块中重复定义相同的数据结构

在我们的重构计划中，`models`目录将包含：

- **ChatModels**：定义聊天相关的数据结构（如Topic、Message、AiModel、AiModelProvider）
- **ConfigModels**：定义配置相关的数据结构
- **共享类型**：定义在多个模块中共享的类型

## 两者的关系

`repositories`和`models`之间的关系是：

- `repositories`负责**如何存储和检索数据**
- `models`定义**要存储和检索的数据结构**

例如，`TopicRepository`负责话题的CRUD操作，而它操作的数据结构由`models/ChatModels.ts`中的`Topic`接口定义。

## 与现有代码的区别

与现有代码相比，这种架构的主要区别是：

1. **职责分离更清晰**：存储逻辑与业务逻辑分离
2. **依赖关系更简单**：服务层依赖存储库，存储库依赖数据库服务
3. **测试更容易**：可以轻松模拟存储库进行单元测试
4. **统一的数据访问方式**：所有数据访问都通过存储库进行

这种架构将帮助我们解决当前存在的问题，如存储逻辑分散、职责不清、依赖关系复杂等。

```

**验证方法**：
- 目录结构检查：确认所有目录已创建
- 代码审查：确保目录结构符合设计规范

#### 1.2 实现数据库服务接口
- 创建`src/services/database/interfaces.ts`
- 定义`IDatabaseService`接口

**验证方法**：
- 代码审查：确保接口设计符合需求
- 单元测试：测试接口定义的完整性

#### 1.3 实现SQLite数据库服务
- 创建`src/services/database/SQLiteService.ts`
- 实现数据库连接、初始化和基本操作

**验证方法**：
- 单元测试：测试数据库连接和基本CRUD操作
- 集成测试：验证数据库文件是否正确创建
- 手动验证：使用SQLite浏览器查看数据库结构

#### 1.4 实现数据库初始化脚本
- 创建`src/services/database/schema.ts`
- 实现表结构定义和索引创建

**验证方法**：
- 单元测试：验证表结构创建是否成功
- 数据库检查：确认所有表和索引已正确创建

## 阶段二：存储库层实现（第3-4周）

### 目标
实现存储库模式，为每种数据类型提供统一的CRUD操作接口。

### 任务

#### 2.1 定义存储库接口
- 创建`src/repositories/interfaces.ts`
- 定义通用存储库接口`IRepository<T, ID>`

**验证方法**：
- 代码审查：确保接口设计符合需求
- 单元测试：测试接口定义的完整性

#### 2.2 实现话题存储库
- 创建`src/repositories/TopicRepository.ts`
- 实现话题的CRUD操作和特定查询方法

**验证方法**：
- 单元测试：测试所有CRUD操作
- 集成测试：验证与数据库的交互
- 性能测试：测量基本操作的性能

#### 2.3 实现消息存储库
- 创建`src/repositories/MessageRepository.ts`
- 实现消息的CRUD操作和特定查询方法

**验证方法**：
- 单元测试：测试所有CRUD操作
- 集成测试：验证与数据库的交互
- 性能测试：测量基本操作的性能

#### 2.4 实现模型和提供商存储库
- 创建`src/repositories/AiModelProviderRepository.ts`
- 创建`src/repositories/AiModelRepository.ts`
- 实现相应的CRUD操作和特定查询方法

**验证方法**：
- 单元测试：测试所有CRUD操作
- 集成测试：验证与数据库的交互
- 性能测试：测量基本操作的性能

#### 2.5 实现配置存储库
- 创建`src/repositories/ConfigRepository.ts`
- 实现配置的CRUD操作

**验证方法**：
- 单元测试：测试所有CRUD操作
- 集成测试：验证与数据库的交互

## 阶段三：服务层重构（第5-7周）

### 目标
重构现有服务层，使用新的存储库和依赖注入模式。

### 任务

#### 3.1 创建服务容器
- 创建`src/services/ServiceContainer.ts`
- 实现依赖注入容器

**验证方法**：
- 单元测试：测试服务注册和获取
- 集成测试：验证服务初始化流程

#### 3.2 定义服务接口
- 创建`src/services/interfaces.ts`
- 定义通用服务接口`IService`

**验证方法**：
- 代码审查：确保接口设计符合需求
- 单元测试：测试接口定义的完整性

#### 3.3 重构聊天服务
- 创建`src/services/chat/ChatService.ts`
- 使用存储库模式重构聊天服务

**验证方法**：
- 单元测试：测试服务功能
- 集成测试：验证与存储库的交互
- 端到端测试：验证完整的聊天流程

#### 3.4 重构模型服务
- 创建`src/services/model/ModelService.ts`
- 使用存储库模式重构模型服务

**验证方法**：
- 单元测试：测试服务功能
- 集成测试：验证与存储库的交互
- 端到端测试：验证模型管理流程

#### 3.5 重构配置服务
- 创建`src/services/system/ConfigService.ts`
- 使用存储库模式重构配置服务

**验证方法**：
- 单元测试：测试服务功能
- 集成测试：验证与存储库的交互
- 端到端测试：验证配置管理流程

#### 3.6 实现数据库位置管理
- 创建`src/services/database/DatabaseLocationManager.ts`
- 实现数据库位置配置和迁移功能

**验证方法**：
- 单元测试：测试位置管理逻辑
- 集成测试：验证数据库位置更改功能
- 用户测试：验证用户体验

## 阶段四：UI集成与性能优化（第8-10周）

### 目标
将重构后的服务集成到UI中，并进行性能优化。

### 任务

#### 4.1 更新UI组件
- 更新所有使用旧服务的UI组件
- 使用新的服务接口

**验证方法**：
- 组件测试：测试UI组件功能
- 端到端测试：验证完整的用户流程
- 用户测试：收集用户反馈

#### 4.2 创建数据库设置页面
- 创建数据库设置UI
- 实现数据库位置选择功能

**验证方法**：
- 组件测试：测试UI组件功能
- 用户测试：验证用户体验

#### 4.3 实现性能优化
- 添加数据库索引
- 优化查询语句
- 实现缓存机制

**验证方法**：
- 性能测试：测量查询性能
- 负载测试：测试大数据量下的性能
- 基准测试：与旧实现比较性能

#### 4.4 实现数据备份和恢复
- 创建数据备份服务
- 实现数据恢复功能

**验证方法**：
- 单元测试：测试备份和恢复逻辑
- 集成测试：验证备份文件的完整性
- 用户测试：验证备份和恢复流程

## 风险与缓解措施

### 1. 性能下降风险
- **风险**：数据库操作可能导致性能下降
- **缓解措施**：
  - 实施性能测试，确保查询性能
  - 实现缓存机制，减少数据库访问
  - 优化数据库索引和查询语句

### 2. 用户体验影响
- **风险**：重构可能暂时影响用户体验
- **缓解措施**：
  - 在后台线程执行耗时操作
  - 提供进度指示器
  - 分阶段发布，确保每个阶段都稳定可用

### 3. 兼容性问题
- **风险**：新旧代码混合可能导致兼容性问题
- **缓解措施**：
  - 实现版本检测
  - 提供回滚机制
  - 全面的测试覆盖

## 验收标准

1. **功能完整性**：所有现有功能在重构后保持不变
2. **性能要求**：重构后的性能不低于原有实现，特定操作有明显提升
3. **代码质量**：通过代码审查，确保符合项目编码规范
4. **测试覆盖率**：单元测试覆盖率不低于80%
5. **用户体验**：用户反馈积极，无明显体验下降

## 里程碑

1. **第2周末**：完成基础设施搭建
2. **第4周末**：完成存储库层实现
3. **第7周末**：完成服务层重构
4. **第10周末**：完成UI集成与性能优化

## 总结

本计划提供了一个全面的数据库与服务层重构方案，通过分阶段实施和严格的验证方法，确保重构过程可控且高质量。每个阶段都有明确的目标、任务和验证方法，以及相应的风险缓解措施。通过这次重构，我们将实现更清晰的代码结构、更高的可维护性和更好的性能。
