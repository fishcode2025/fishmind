# 数据库与服务层重构 - 阶段三实施计划

## 概述

本文档详细描述了数据库与服务层重构的第三阶段：服务层重构。在前两个阶段中，我们已经完成了数据库服务和存储库层的实现。第三阶段将专注于重构现有服务层，使用新的存储库和依赖注入模式，并确保所有服务遵循统一的命名规范。

## 命名规范

所有服务类将遵循以下命名规范：

1. **统一后缀**：所有服务类统一使用"Service"作为后缀
2. **AI模型服务**：使用"AiModelService"而非"ModelService"，以避免与数据模型(Model)概念混淆
3. **数据库位置管理**：作为配置服务的一部分，而非单独的服务

主要服务包括：
- `DatabaseService`：负责数据库基本操作
- `ConfigService`：管理应用配置，包括数据库位置设置
- `ChatService`：处理聊天相关功能
- `AiModelService`：管理AI模型和提供商

## 任务清单

### 3.1 创建服务接口（第1天）

#### 任务描述
创建统一的服务接口定义，为所有服务提供一致的基础接口。

#### 具体步骤
1. 创建`src/services/interfaces.ts`文件
2. 定义基础`IService`接口，包含`initialize()`和`dispose()`方法
3. 定义`IChatService`接口，继承自`IService`
4. 定义`IAiModelService`接口，继承自`IService`
5. 定义`IConfigService`接口，继承自`IService`

#### 验证方法
- 代码审查：确保接口设计符合需求和命名规范
- 编译检查：确保TypeScript编译无错误
- 单元测试：编写测试用例验证接口定义的完整性

### 3.2 创建服务容器（第2天）

#### 任务描述
实现服务容器，用于管理服务实例和依赖注入。

#### 具体步骤
1. 创建`src/services/ServiceContainer.ts`文件
2. 实现`ServiceContainer`类，使用单例模式
3. 实现服务注册方法`register<T>(key: string, service: T): void`
4. 实现服务获取方法`get<T>(key: string): T`
5. 实现服务初始化方法`initialize(): Promise<void>`
6. 实现服务释放方法`dispose(): Promise<void>`

#### 验证方法
- 单元测试：测试服务注册和获取功能
- 单元测试：测试服务初始化和释放功能
- 集成测试：验证多个服务的依赖注入

### 3.3 实现配置服务（第3-4天）

#### 任务描述
实现配置服务，负责管理应用配置，包括数据库位置设置。

#### 具体步骤
1. 创建`src/services/config/ConfigService.ts`文件
2. 实现`ConfigService`类，实现`IConfigService`接口
3. 使用`ConfigRepository`存储和检索配置
4. 实现配置变更通知机制
5. 实现数据库位置配置管理功能
6. 实现类型安全的配置访问方法

#### 验证方法
- 单元测试：测试配置的存储和检索
- 单元测试：测试配置变更通知机制
- 集成测试：验证与数据库的交互
- 功能测试：验证数据库位置配置功能

### 3.4 实现AI模型服务（第5-7天） 

#### 任务描述
实现AI模型服务，负责管理模型提供商和模型。

#### 具体步骤
1. 创建`src/services/aimodel/AiModelService.ts`文件
2. 实现`AiModelService`类，实现`IAiModelService`接口
3. 使用`AiModelProviderRepository`和`AiModelRepository`存储和检索数据
4. 实现提供商管理功能（添加、更新、删除、查询）
5. 实现模型管理功能（添加、更新、删除、查询）
6. 实现模型能力查询功能

#### 验证方法
- 单元测试：测试提供商管理功能
- 单元测试：测试模型管理功能
- 集成测试：验证与存储库的交互
- 功能测试：验证模型能力查询功能
- 性能测试：测量查询性能

### 3.5 实现聊天服务（第8-10天）

#### 任务描述
实现聊天服务，负责管理话题和消息。

#### 具体步骤
1. 创建`src/services/chat/ChatService.ts`文件
2. 实现`ChatService`类，实现`IChatService`接口
3. 使用`ChatTopicRepository`和`ChatMessageRepository`存储和检索数据
4. 实现话题管理功能（创建、更新、删除、查询）
5. 实现消息管理功能（发送、删除、查询）
6. 实现AI回复生成功能，与`AiModelService`集成

#### 验证方法
- 单元测试：测试话题管理功能
- 单元测试：测试消息管理功能
- 集成测试：验证与存储库的交互
- 集成测试：验证与`AiModelService`的集成
- 功能测试：验证完整的聊天流程
- 性能测试：测量消息处理性能

### 3.6 更新应用初始化逻辑（第11天）

#### 任务描述
更新应用初始化逻辑，使用新的服务容器和服务。

#### 具体步骤
1. 修改`src/App.tsx`文件
2. 实现服务容器初始化
3. 注册所有服务
4. 实现应用启动和关闭逻辑
5. 添加错误处理和加载状态

#### 验证方法
- 集成测试：验证应用初始化流程
- 功能测试：验证服务依赖关系
- 错误处理测试：验证错误处理机制
- 性能测试：测量应用启动时间

### 3.7 创建服务单元测试（第12-14天）

#### 任务描述
为所有服务创建全面的单元测试。

#### 具体步骤
1. 创建`src/services/__tests__`目录
2. 为`ConfigService`创建单元测试
3. 为`AiModelService`创建单元测试
4. 为`ChatService`创建单元测试
5. 为`ServiceContainer`创建单元测试
6. 实现测试辅助工具和模拟对象

#### 验证方法
- 测试覆盖率：确保测试覆盖率达到80%以上
- 测试通过率：确保所有测试通过
- 代码审查：确保测试质量和完整性

### 3.8 创建服务集成测试（第15-16天）

#### 任务描述
创建服务之间的集成测试，验证服务之间的交互。

#### 具体步骤
1. 创建`src/services/__tests__/integration`目录
2. 创建配置服务与数据库服务的集成测试
3. 创建AI模型服务与存储库的集成测试
4. 创建聊天服务与AI模型服务的集成测试
5. 创建完整服务链的集成测试

#### 验证方法
- 测试通过率：确保所有集成测试通过
- 功能验证：确保服务之间正确交互
- 性能测量：记录关键操作的性能指标

### 3.9 清理旧代码（第17-18天）

#### 任务描述
清理services文件夹下的旧代码和文件，确保代码库的整洁和一致性。

#### 具体步骤
1. 创建旧代码备份（可选）
2. 识别并列出所有需要清理的旧服务文件和目录
3. 检查旧服务的依赖关系，确保没有遗漏的功能
4. 逐步移除旧的服务文件：
   - `src/services/chatService/`
   - `src/services/modelService/`
   - `src/services/mcpService/`
   - `src/services/defaultModel/`
   - `src/services/storage/`（如果功能已迁移到新服务）
   - 其他不再需要的服务目录
5. 更新导入语句，确保没有引用已删除的文件
6. 运行全面测试，确保删除旧代码后应用仍然正常工作

#### 验证方法
- 编译检查：确保删除旧代码后编译无错误
- 功能测试：验证所有功能仍然正常工作
- 代码审查：确保没有遗留的无用代码
- 性能测试：确保性能没有下降

### 3.10 文档编写（第19天）

#### 任务描述
编写服务层的详细文档，包括架构、接口和使用示例。

#### 具体步骤
1. 更新架构文档，描述服务层结构
2. 为每个服务编写详细文档
3. 编写服务使用示例
4. 编写服务扩展指南
5. 更新README.md文件

#### 验证方法
- 文档审查：确保文档准确性和完整性
- 示例验证：确保所有示例可以正常工作
- 用户反馈：收集团队成员对文档的反馈

### 3.11 代码审查和优化（第20天）

#### 任务描述
进行全面的代码审查和优化，确保代码质量和性能。

#### 具体步骤
1. 进行代码审查，检查命名规范和代码风格
2. 优化性能瓶颈
3. 重构重复代码
4. 添加详细注释
5. 确保错误处理的完整性

#### 验证方法
- 代码审查：确保代码符合项目规范
- 性能测试：确保性能达到要求
- 代码质量工具：使用ESLint和SonarQube等工具检查代码质量
- 用户测试：收集用户反馈

## 风险与缓解措施

### 1. 服务依赖复杂性
- **风险**：服务之间的依赖关系可能变得复杂，导致初始化顺序问题
- **缓解措施**：
  - 在服务容器中实现依赖解析
  - 明确记录服务依赖关系
  - 实现服务延迟初始化机制

### 2. 性能下降
- **风险**：重构可能导致性能暂时下降
- **缓解措施**：
  - 实施性能基准测试
  - 优先优化关键路径
  - 实现缓存机制减少数据库访问

### 3. 兼容性问题
- **风险**：新旧代码混合可能导致兼容性问题
- **缓解措施**：
  - 实现适配器模式过渡
  - 全面的集成测试
  - 分阶段部署和验证

### 4. 清理旧代码风险
- **风险**：删除旧代码可能导致功能丢失或引用错误
- **缓解措施**：
  - 在删除前创建代码备份
  - 使用依赖分析工具检查引用关系
  - 增量删除并在每个步骤后进行测试
  - 保持详细的删除日志，便于回溯问题

## 里程碑

1. **第4天**：完成服务接口和服务容器
2. **第7天**：完成配置服务和AI模型服务
3. **第10天**：完成聊天服务
4. **第14天**：完成单元测试
5. **第16天**：完成集成测试
6. **第18天**：完成旧代码清理
7. **第20天**：完成文档和代码优化

## 验收标准

1. **功能完整性**：所有服务功能正常工作
2. **代码质量**：通过代码审查，符合项目规范
3. **测试覆盖率**：单元测试覆盖率达到80%以上
4. **性能要求**：关键操作性能不低于重构前
5. **文档完整性**：文档完整、准确、易于理解
6. **代码整洁性**：没有冗余或废弃的代码

## 总结

本计划详细描述了服务层重构的各个任务、验证方法和里程碑。通过遵循统一的命名规范和架构设计，我们将实现一个更加清晰、可维护和高性能的服务层。每个任务都有明确的验证方法，确保重构过程可控且高质量。特别注意的是，在新服务设计并验证通过后，我们将清理旧代码，确保代码库的整洁和一致性。 